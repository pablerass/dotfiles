#!/bin/bash

DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

CONF_DIR=$HOME/conf/mfa
CONF=default

if [ ! -z "$1" ]; then
    CONF=$1
fi

CONF_FILE=$CONF_DIR/$CONF

if [ ! -e $CONF_FILE ]; then
    echo "MFA $CONF does not exists" 1>&2
    exit 1
fi

SERIAL=arn:aws:iam::852120833692:mfa/pablo.munoz

aws sts get-session-token \
    --serial-number $SERIAL --token-code $($DIR/mfa $CONF) \
  | jq -r ".Credentials.SessionToken"