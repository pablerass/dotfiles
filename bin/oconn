#!/bin/bash

CONF_DIR=$HOME/conf/openvpn
CONF=default

if [ ! -z "$2" ]; then
    CONF=$2
fi

CONF_FILE=$CONF_DIR/$CONF.ovpn

start() {
    if [ ! -e $CONF_FILE ]; then
        echo "OpenVPN $CONF does not exists" 1>&2
        exit 1
    fi
    echo "Connecting to $CONF OpenVPN"
    sudo /usr/sbin/openvpn \
        --config $CONF_FILE \
        --daemon ovpn-$CONF
}

stop() {
    for CONF_FILE in $CONF_DIR/*.ovpn; do
        CONF_FILENAME=$(basename $CONF_FILE)
        CONF=${CONF_FILENAME%.*}
        COMMAND="/usr/sbin/openvpn --config $CONF_FILE --daemon ovpn-$CONF"
        if pgrep -f "$COMMAND" > /dev/null 2>&1; then
            echo "Stopping $CONF OpenVPN connection"
            sudo /usr/bin/pkill -f "/usr/sbin/openvpn --config $CONF_FILE --daemon ovpn-$CONF"
        fi
    done
}

case "$1" in
    ""|start)
        start
        ;;
    stop)
        stop
        ;;
    restart)
        stop && start
        ;;
    *)
        echo "usage: $0 start|stop|restart" >&2
        exit 1
        ;;
esac